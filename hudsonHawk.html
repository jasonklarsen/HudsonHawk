<html>
<head>
  <title>Hudson Hawk</title>
  <link type="text/css" href="http://jqueryui.com/latest/themes/base/jquery.ui.all.css" rel="stylesheet" />
  <style>
  body { background-color: green; }
  .job { position: relative; text-align: center; border: 2px black solid; font-size: 400%; white-space: nowrap; }
  .broken { background-color: darkred; left: 0px; }
  .failed { background-color: red; left: 0px; }
  .passed { background-color: green; left: 0px; }
  .unknown { background-color: yellow; left: 0px; }
  input.url { width: 350px; }
  </style>
</head>
<body>
<div id="jobs"></div>
<div id="popup" style="display: none"></div>
<script src="http://www.google.com/jsapi"></script>
<script>google.load("jquery", "1.4.2"); google.load("jqueryui", "1.7.2");</script>

<script>
/** Watcher of Hudson jobs. */
var Hawk = (function() {

  var colorToState = { red: "broken", red_anime: "broken", yellow: "failed", yellow_anime: "failed",
                       blue: "passed", blue_anime: "passed", aborted: "unknown", aborted_anime: "unknown" }
  
  var awaken = function(hudson, prey, flightPlan) {
    flightPlan.request(hudson, function(view) {
      hudson.jobsFor(view, starting(prey));
    });
  };
  
  var starting = function(prey) {
    return function(jobs) {
      $.each(jobs, function(i, job) {
        if (job.color !== 'blue' && job.color !== 'blue_anime') {
          prey.target(job.name, colorToState[job.color]);
        }
      });
    }
  };
  
  return {
    awaken: awaken
  };  
})();

/** Hudson jobs to watch for */
var Prey = (function() {
  var listing = {};
  
  var target = function(name, state) {
    listing[name] = state;
    addToRadar(name, state);
  };
   
  var addToRadar = function(name, state) {
//    $('#jobs').append('<div id="' + name + '"><span class="' + (state || 'unknown') + ' job">' + name + '</span></div>');
    $('#jobs').append('<div id="' + name + '" class="' + (state || 'unknown') + ' job">' + name + '</div>');
  };
  
  return {
    target: target
  };
})();

/**  Storage utils (via Cookies or HTML5 storage if supported) */
var Storage = (function() {
  var cookieStorage = {
    write: function(name, value) {
      var date = new Date();
      date.setTime(date.getTime() + (500 * 24 * 60 * 60 * 1000)); // 500 days from now
      document.cookie = name + "=" + value + "; expires=" + date.toGMTString() + "; path=/";
    },
    read: function(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) == 0) {
          return c.substring(nameEQ.length, c.length);
        }
      }
      return null;
    }
  }
  
  var hasLocalStorage = function() { return !!localStorage && !$.browser.mozilla; } ;// Firefox 3.5 has localStorage but it doesn't seem to work right....
  
  var storage = hasLocalStorage() ? { write: function(name, value) { localStorage.setItem(name, value); }, read: function(name) { return localStorage.getItem(name); } } : cookieStorage; 
  
  return {
    write: storage.write,
    erase: function(name) { storage.write(name, ""); },
    read: storage.read
  }
})();

/** Configuration options */
var FlightPlan = (function() {
  var serverUrl = Storage.read('HudsonHawk.serverUrl');
  var viewName = Storage.read('HudsonHawk.viewName');
  
  var popupRequestForInfo = function(title, formBuilder, okCallback) {
    var popup = $('#popup');
    popup.empty();
    popup.dialog({ 
      buttons: { 'OK': function() {  $(this).dialog("close"); okCallback(); } },
      hide: "slide",
      modal: true,
      width: 400,
      title: title,
      open: function(event, ui) { formBuilder(popup); }
    });  
  };
  
  var requestViaPopups = function(hudson, callBackAfterFlightPlan) {
    if (serverUrl) {
      Hudson.redirectTo(serverUrl);
      if (viewName) {
        callBackAfterFlightPlan(viewName);
      } else {
        requestView(hudson, callBackAfterFlightPlan);
      }
    } else {
      popupRequestForInfo("Enter Hudson server url", urlFormBuilder, function() {
        var newUrl = $('#urlOption').val(); 
        hudson.redirectTo(newUrl);
        Storage.write('HudsonHawk.serverUrl', newUrl);        
        requestView(hudson, callBackAfterFlightPlan);        
      });
    }
  };
  
  var urlFormBuilder = function(popup) { popup.append("<input id='urlOption' class='url' value='http://'></input>"); }

  var requestView = function(hudson, callBackAfterFlightPlan) {
    hudson.viewsFor(function(views) {
      var viewFormBuilder = function(popup) {
        popup.append("<select id='viewOption'></select>");
        var selector = $('#viewOption');
        $.each(views, function(i, view) {
          selector.append("<option value='" + view['name'] + "'>" + view['name'] + "</option>");
        });        
      };
      
      popupRequestForInfo("Choose a Hudson view to monitor", viewFormBuilder, function() {
        var newViewName = $('#viewOption').val(); 
        Storage.write('HudsonHawk.viewName', newViewName);
        callBackAfterFlightPlan(newViewName); 
      });        
    });
  };
    
  return {
    request: requestViaPopups
  };
})();

/** Hudson wrapper */
var Hudson = (function() {  
  var hudsonUrl;
  
  var callHudsonFor = function(depth, callback, view) {
    var viewName = view ? "view/" + view + "/" : '';
    $.ajax({
      url: hudsonUrl + viewName + 'api/json',
      dataType: 'jsonp',
      jsonp: 'jsonp',
      data: 'depth=' + depth,
      success: callback,
      error: function(request, status, error) {
        alert("Error: " + status);
      }
    });    
  };
  
  var viewsFor = function(callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.views); });
  };

  var jobsFor = function(view, callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.jobs); }, view);
  };
  
  var redirectTo = function(dirtyUrl) {
    var cleanerUrl = dirtyUrl.indexOf('http') > -1 ? dirtyUrl : "http://" + dirtyUrl;
    hudsonUrl = cleanerUrl.charAt(cleanerUrl.length - 1) === '/' ? cleanerUrl : cleanerUrl + "/";
  };

  return {
    viewsFor: viewsFor,
    jobsFor: jobsFor,
    redirectTo: redirectTo
  };
})();

Hawk.awaken(Hudson, Prey, FlightPlan);

</script>
</body>
</html>
