<html>
<head>
  <title>Hudson Hawk</title>
  <link type="text/css" href="http://jqueryui.com/latest/themes/base/jquery.ui.all.css" rel="stylesheet" />
  <style>
  .notready { background-color: grey; }
  .ready { background-color: green; }
  .job { position: relative; text-align: center; border: 2px black solid; font-size: 400%; white-space: nowrap; }
  .broken { background-color: darkred; left: 0px; }
  .failed { background-color: red; left: 0px; }
  .passed { background-color: green; left: 0px; }
  .unknown { background-color: yellow; left: 0px; }
  input.url { width: 350px; }
  </style>
</head>
<body class="notready">
<div id="jobs"></div>
<div id="popup" style="display: none"></div>
<script src="http://www.google.com/jsapi"></script>
<script>google.load("jquery", "1.4.2"); google.load("jqueryui", "1.7.2");</script>
<script src="http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js"></script>
<script>
/** Watcher of Hudson jobs. */
var Hawk = function(hudson, prey, flightPlan) {
  
  var awaken = function() {
    flightPlan.requestViewAndThen(function(view) {
      var attackPlan = function() { 
        hudson.jobsFor(view, thenAddTo(prey)); 
        setTimeout(attackPlan, 30000); 
      }
      attackPlan();
    });
  };
  
  var thenAddTo = function(prey) {
    return function(jobs) {
      var failedJobs = $(jobs).filter(function() { return this.color !== 'blue' && this.color !== 'blue_anime'; });
      prey.target(failedJobs);
      $('body').removeClass('notready').addClass('ready');
    };
  };
  
  return { awaken: awaken };  
};

/** Hudson jobs to watch for */
var Prey = function(radar) {

  var Listing = function(job) {
    return { name: job.name, 
             color: job.color, 
             inProgress: job.color.indexOf('anime') > -1,
             buildNumber: job.lastCompletedBuild ? job.lastCompletedBuild.number: null };
  };
 
  var Listings = function(jobs) {
    var names = {}, values = [];
    $(jobs).each(function(i, job) {
      var value = Listing(job);
      names[job.name] = value;
      values.push(value);
    });
    return { names: names, values: values };
  };
  
  var listings = Listings([]);
  
  var target = function(jobs) {
    var newListings = Listings(jobs);
    
    var notInNewList = function(i, listing) { return !newListings.names[listing.name]; };
    var notInOldList = function(i, listing) { return !listings.names[listing.name]; };
    var withChangedBuildNumbers = function(i, listing) { return newListings.names[listing.name] && listing.buildNumber !== newListings.names[listing.name].buildNumber; };
    var nowInProgress = function(i, listing) { return listing.inProgress; };
    
    filter(listings, notInNewList).andForEach(function(i, listing) { radar.remove(listing); });
    filter(newListings, notInOldList).andForEach(function(i, listing) { radar.add(listing); });
    filter(listings, withChangedBuildNumbers).andForEach(function(i, listing) { radar.remove(listing); radar.add(listing); });
    filter(newListings, nowInProgress).andForEach(function(i, listing) { radar.highlight(listing); });
    
    listings = newListings;
  };
  
  var filter = function(listings, filterFxn) { 
    return { andForEach: function(closure) { 
      $(listings.values).filter(filterFxn).each(closure);
    } };
  }
    
  return {
    target: target
  };
};

/** View of the Prey data */
var Radar = function(hudson) {
  
  var colorToState = { red: "broken", red_anime: "broken", yellow: "failed", yellow_anime: "failed",
                       blue: "passed", blue_anime: "passed", aborted: "unknown", aborted_anime: "unknown" }
  
  var remove = function(listing) {
    $("#" + listing.name).hide("blind", { direction: "vertical" }, 5000);
    setTimeout(function() { $("#" + listing.name).remove(); }, 5000);
  }
  
  var add = function(listing) {
    var jobClass = colorToState[listing.color] || 'unknown';
    $('#jobs').prepend('<div id="' + listing.name + '" class="' + jobClass + ' job" style="display: none">' + listing.name + '</div>');
    
    $("#" + listing.name)
//      .click(function() { hudson.changeDescription(listing.name, listing.buildNumber, 'HAWK:'); })
      .show("blind", { direction: "vertical" }, 2000);
  };
  
  var highlight = function(listing) {
    $("#" + listing.name).effect("pulsate", { times: 10000 }, 5000);
  };
  
  return { remove: remove, add: add, highlight: highlight };
};

/**  Storage utils (via Cookies or HTML5 storage if supported) */
var Storage = (function() {
  var cookieStorage = {
    write: function(name, value) {
      var date = new Date();
      date.setTime(date.getTime() + (500 * 24 * 60 * 60 * 1000)); // 500 days from now
      document.cookie = name + "=" + value + "; expires=" + date.toGMTString() + "; path=/";
    },
    read: function(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) == 0) {
          return c.substring(nameEQ.length, c.length);
        }
      }
      return null;
    }
  }
  
  var hasLocalStorage = function() { return !$.browser.mozilla && !!localStorage; } ;// Firefox 3.5 has localStorage but it doesn't seem to work right....
  
  var storage = hasLocalStorage() ? { write: function(name, value) { localStorage.setItem(name, value); }, read: function(name) { return localStorage.getItem(name); } } : cookieStorage; 
  
  return {
    write: storage.write,
    erase: function(name) { storage.write(name, ""); },
    read: storage.read
  }
})();

/** Configuration options */
var FlightPlan = function(storage, hudson) {
  var serverUrl = function() { return storage.read('HudsonHawk.serverUrl') };
  var viewName = function() { return storage.read('HudsonHawk.viewName') };
  var userName = function() { return storage.read('HudsonHawk.userName') };
  var password = function() { return storage.read('HudsonHawk.password') };
  
  var popupRequestForInfo = function(title, formBuilder, okCallback) {
    var popup = $('#popup');
    popup.empty();
    popup.dialog({ 
      buttons: { 'OK': function() {  $(this).dialog("close"); okCallback(); } },
      hide: "slide",
      modal: true,
      width: 'auto',
      maxWidth: 400,
      height: 'auto',
      maxHeight: 800,
      closeOnEscape: true,
      title: title,
      open: function(event, ui) { formBuilder(popup); }
    });  
  };
  
  var openSettings = function(callbackOnOk) {
    if (serverUrl()) {
      hudson.redirectTo(serverUrl(), userName(), password());
      refreshViewsOnPopup();
      refreshUsersOnPopup();
    }
    
    popupRequestForInfo("Settings", settingsForm, function() {
      var newUrl = $('#urlOption').val(); 
      storage.write('HudsonHawk.serverUrl', newUrl);        
      var newViewName = $('#viewOption').val(); 
      storage.write('HudsonHawk.viewName', newViewName);
      var newUsername = $('#userOption').val();
      storage.write('HudsonHawk.userName', newUsername);  
      var newPassword = $('#passwordOption').val();
      storage.write('HudsonHawk.password', newPassword);      
      hudson.redirectTo(newUrl, newUsername, newPassword);
      callbackOnOk(newViewName);
    });
  };
  
  var generateSelect = function(id, values) {
    var selectBox = ["<select id='" + id + "'>"];
    $.each(values, function(i, value) {
      selectBox[i + 1] = "<option value='" + value + "'>" + value + "</option>";
    });        
    selectBox.push("</select>");
    $('#' + id).replaceWith(selectBox.join(""));
  };
  
  var refreshViewsOnPopup = function() {
    $('#viewOption').replaceWith("<i id='viewOption'>Refreshing views from Hudson...</i>");
    hudson.viewsFor(function(views) {
      generateSelect("viewOption", $(views).map(function(i, view) { return view.name; }));
      $('#viewOption').val(storage.read('HudsonHawk.viewName'));
    });
  }; 
  
  var refreshUsersOnPopup = function() {
    $('#userOption').replaceWith("<i id='userOption'>Refreshing users from Hudson...</i>");
    hudson.usersFor(function(users) {
      generateSelect("userOption", $(users).map(function(i, user) { return user.user.fullName; }));
      $('#userOption').val(storage.read('HudsonHawk.userName'));
    });
  };
  
  var settingsForm = function(popup) {
    var table = "<table><tbody>" 
                + row("Hudson URL:", "<input id='urlOption' class='url' value='" + (serverUrl() || "http://") + "'></input>") 
                + row("View:", "<i id='viewOption'>" + (viewName() || "<none>") + "</i>")
                + row("User:", "<i id='userOption'>" + (userName() || "<none>") + "</i>")
                + row("Password:", "<input id='passwordOption' type='password' value='" + (password() || "") + "'></input>") 
                + "</tbody></table>";
    popup.append(table);
    $('#urlOption').change(function() { 
      refreshViewsOnPopup(); 
      refreshUsersOnPopup();
    });
  };
  
  var row = function(prompt, formElement) {
    return "<tr><td>" + prompt + "</td><td>" + formElement + "</td></tr>";
  };
  
  return { requestViewAndThen: openSettings };
};

/** Hudson wrapper */
var Hudson = (function() {  
  var hudsonUrl;
  var username;
  var password;
  
  var callHudsonFor = function(depth, callback, directory) {
    $.ajax({
      url: hudsonUrl + directory + 'api/json',
      dataType: 'jsonp',
      jsonp: 'jsonp',
      data: 'depth=' + depth,
      success: callback,
      error: function(request, status, error) {
        alert("Error: " + status);
      }
    });    
  };
  
  var viewsFor = function(callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.views); }, "");
  };

  var usersFor = function(callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.users); }, "people/");
  };

  var jobsFor = function(view, callback) {
    var viewName = view ? "view/" + view + "/" : '';
    callHudsonFor(1, function(hudson) { callback(hudson.jobs); }, viewName);
  };
  
  var redirectTo = function(dirtyUrl, newUsername, newPassword) {
    var cleanerUrl = dirtyUrl.indexOf('http') > -1 ? dirtyUrl : "http://" + dirtyUrl;
    hudsonUrl = cleanerUrl.charAt(cleanerUrl.length - 1) === '/' ? cleanerUrl : cleanerUrl + "/";
    username = newUsername;
    password = newPassword;
  };

  var changeDescription = function(jobName, buildNumber, newDescription) {
    var iframeId = "authFrame" + new Date().getTime();
    var params = { j_username: username, j_password: password, remember_me: true, from: "/" };
    var src = hudsonUrl + "/j_acegi_security_check?Submit=log+in&" + $.param(params) + "&json=" + $.param($.toJSON(params));
        
    $('#jobs').after('<iframe id="' + iframeId + '" style="display:none" src="' + src + '"></iframe>');
    var iframe = $('iframe#' + iframeId);
    iframe.load(function() {
      setTimeout(function() {
         iframe.unbind();
         iframe.attr('src', hudsonUrl + '/job/' + jobName + '/' + buildNumber + '/submitDescription?Submit=Submit&description=' + encodeURI(newDescription) + '&json=' + $.param({ description: newDescription }));
         iframe.load(function() {
           setTimeout(function() {
             iframe.unbind();
             iframe.attr('src', hudsonUrl + '/logout');
             iframe.load(function() {
               setTimeout(function() {
                 $('iframe#' + iframeId).remove();
               }, 100);
             });
           }, 100);      
         });
      }, 100);
    });        
  }
  
  return {
    viewsFor: viewsFor,
    jobsFor: jobsFor,
    usersFor: usersFor,
    redirectTo: redirectTo,
    changeDescription: changeDescription
  };
})();

var hudson = Hudson;
var radar = Radar(hudson);
var prey = Prey(radar);
var storage = Storage;
var flightPlan = FlightPlan(storage, hudson);
var hawk = Hawk(hudson, prey, flightPlan);

hawk.awaken();

</script>
</body>
</html>
