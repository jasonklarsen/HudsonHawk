<html>
<head>
  <title>Hudson Hawk</title>
  <style>
  body { background-color: green; }
  .job { position: relative; text-align: center; border: 2px black solid; font-size: 400%; white-space: nowrap; }
  .broken { background-color: darkred; left: 0px; }
  .failed { background-color: red; left: 0px; }
  .passed { background-color: green; left: 0px; }
  .unknown { background-color: yellow; left: 0px; }
  </style>
</head>
<body>
<div id="jobs"></div>
<script src="http://www.google.com/jsapi"></script>
<script>google.load("jquery", "1.4.2"); google.load("jqueryui", "1.7.2");</script>

<script>
/** Watcher of Hudson jobs. */
var Hawk = (function() {

  var colorToState = { red: "broken", red_anime: "broken", yellow: "failed", yellow_anime: "failed",
                       blue: "passed", blue_anime: "passed", aborted: "unknown", aborted_anime: "unknown" }
  
  var awaken = function(hudson, prey, flightPlan) {
    flightPlan.request(hudson, function() {
      hudson.jobsFor(starting(prey));
    });
//    $('#TIM-browser-IE6')
//    .animate({
//      top: "+=" + ($('body').innerHeight() - 20)
//    }, 10000);
  };
  
  var starting = function(prey) {
    return function(jobs) {
      $.each(jobs, function(i, job) {
        if (job.color !== 'blue' && job.color !== 'blue_anime') {
          prey.target(job.name, colorToState[job.color]);
        }
      });
    }
  };
  
  return {
    awaken: awaken
  };  
})();

/** Hudson jobs to watch for */
var Prey = (function() {
  var listing = {};
  
  var target = function(name, state) {
    listing[name] = state;
    addToRadar(name, state);
  };
   
  var addToRadar = function(name, state) {
//    $('#jobs').append('<div id="' + name + '"><span class="' + (state || 'unknown') + ' job">' + name + '</span></div>');
    $('#jobs').append('<div id="' + name + '" class="' + (state || 'unknown') + ' job">' + name + '</div>');
  };
  
  return {
    target: target
  };
})();

/** Configuration options */
var FlightPlan = (function() {
  var viewName;
  
  var requestViaPopup = function(hudson, callBackAfterFlightPlan) {
    if (viewName === undefined) {
      hudson.viewsFor(function(views) {
        //popup for views....
        callBackAfterFlightPlan();
      });
    } else {
      callBackAfterFlightPlan();
    }
  };
  
  return {
    request: requestViaPopup
  };
})();

/** Hudson wrapper */
var Hudson = (function() {

  var callHudsonFor = function(depth, callback) {
    $.ajax({
//      url: 'http://10.108.10.155:8080/api/json',
      url: 'http://10.108.10.155:8080/api/json',
      dataType: 'jsonp',
      jsonp: 'jsonp',
      data: 'depth=' + depth,
      success: callback,
      error: function(request, status, error) {
        alert("Error: " + status);
      }
    });    
  };
  
  var viewsFor = function(callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.views); });
  };

  var jobsFor = function(callback) {
    callHudsonFor(0, function(hudson) { callback(hudson.jobs); });
  };

  return {
    viewsFor: viewsFor,
    jobsFor: jobsFor
  };
})();

Hawk.awaken(Hudson, Prey, FlightPlan);

</script>
</body>
</html>
