<html>
<head>
  <title>Hudson Hawk</title>
  <link type="text/css" href="http://jqueryui.com/latest/themes/base/jquery.ui.all.css" rel="stylesheet" />
  <style>
  .notready { background-color: grey; }
  .ready { background-color: green; }
  .job { margin: 6px; text-shadow: 2px 2px 5px #000; font-weight:bold; color:#fff; -webkit-box-shadow: 3px 3px 4px #000; -webkit-border-radius: 10px; position: relative; text-align: center; border: 2px black solid; font-family: sans-serif; font-size: 375%; white-space: nowrap; cursor: pointer; }
  .job .count { color: #bbb; }
  .jobdetail { border: 4px black solid; font-size: 500%; white-space: nowrap; text-shadow: 2px 2px 5px #000; font-weight:bold; color:#fff; font-family: sans-serif; }
  .jobdetail .count { font-size: 50%; color: #bbb; }
  
  .mini .job { text-shadow: 1px 1px 3px #000; -webkit-box-shadow: none; -webkit-border-radius: 0; font-size: 100%; }
  .mini .jobdetail { font-size: 125%; text-shadow: 1px 1px 3px #000; }
  .mini .ui-dialog { padding: 0; }
  .mini .ui-dialog .ui-dialog-titlebar { padding: 0; }
  .mini .ui-dialog .ui-dialog-buttonpane { padding: 0 0 0 5px; }
  .mini .ui-dialog .ui-dialog-buttonpane button { padding: 0; }
  .mini .ui-widget { font-size: 0.9em; }
  .mini .ui-widget td { font-size: 0.8em; }
  .mini input.url { width: 100px; }
  .mini #settings { font-size: 0.8em; }
   
  .broken, .ui-dialog div.broken { background-color: darkred; }
  .failed, .ui-dialog div.failed { background-color: red; }
  .fixed, .ui-dialog div.fixed { background-color: orange; }
  .flicker, .ui-dialog div.flicker { background-color: purple; color: white; }
  .passed, .ui-dialog div.passed { background-color: green; }
  .aborted, .ui-dialog div.aborted { background-color: yellow; }
  .unknown, .ui-dialog div.unknown { background-color: yellow; }

  input.url { width: 350px; }
  #settings { position: absolute; bottom: 0; right: 0; display: none; }
  #settings button { padding: 3px; font-size: 150%; }
  .ready #settings { display: block; }
  </style>
</head>
<body class="notready">

<div id="jobs">
<div id="settings"><button type="button">Settings</button></div>
</div>
<div id="details" class="details"></div>
<div id="popup" style="display: none"></div>

<script src="http://www.google.com/jsapi"></script>
<script>google.load("jquery", "1.4.2"); google.load("jqueryui", "1.7.2");</script>
<script src="http://jquery-json.googlecode.com/files/jquery.json-2.2.min.js"></script>
<script>
/** Watcher of Hudson jobs. */
var Hawk = function(hudson, prey, territory) {
  
  var awaken = function() {
    territory.recallViewAndThen(function(view) {
      hudson.failedJobsFor(view, loadInto(prey)); 
      beginSurveillanceOver(view);
    });
    setupRefresh();
  };
  
  var beginSurveillanceOver = function(view) {
    var flightPlan = function() { 
      var xhr = hudson.failedJobsFor(view, function(jobs) {
        prey.target(jobs); 
        setTimeout(flightPlan, 20000); 
      });
//      setTimeout(function() { xhr.abort(); flightPlan(); }, 300000);
    };
    setTimeout(flightPlan, 20000);  
  };
  
  var setupRefresh = function() {
    setTimeout(function() { location.reload(true); }, 60 * 60 * 1000); // 1 hour
  };
  
  var loadInto = function(prey) {
    return function(jobs) {
      prey.initializeWith(jobs);
    };
  };
    
  return { awaken: awaken };  
};

/** Hudson jobs to watch for */
var Prey = function(radar) {

  var colorToState = { red: "broken", yellow: "failed", blue: "passed", aborted: "aborted" };
  
  var getState = function(color, description) {
    var fromColor = function() {
      return colorToState[color.replace("_anime", "")]; 
    };
    var fromDescription = function() {
      return description.indexOf('Build: Flicker') === 0 ? "flicker" : (description.indexOf('Build: Fixed') === 0 ? "fixed" : null);
    };  
    return fromDescription() || fromColor() || 'unknown';
  };
  
  var Listing = function(job) {
    var newDescription = job.lastCompletedBuild && job.lastCompletedBuild.description ? job.lastCompletedBuild.description: "";
    return { name:               job.name, 
             state:              getState(job.color, newDescription), 
             url:                job.lastCompletedBuild ? job.lastCompletedBuild.url : "",
             inProgress:         job.color.indexOf('anime') > -1 || job.inProgress,
             progress:           job.progress,
             description:        newDescription,
             numberSinceFailure: job.lastCompletedBuild && job.lastStableBuild ? parseInt(job.lastCompletedBuild.number) - parseInt(job.lastStableBuild.number) : "??",
             buildNumber:        job.lastCompletedBuild ? job.lastCompletedBuild.number: null };
  };
 
  var Listings = function(jobs) {
    var names = {}, values = [];
    $(jobs).each(function() {
      var value = Listing(this);
      names[this.name] = value;
      values.push(value);
    });
    return { names: names, values: values };
  };
  
  var currentListings = Listings([]);
  
  var initialize = function(jobs) {
    currentListings = Listings(jobs);
    $(currentListings.values).each(function() { radar.load(this); });
    filter(currentListings, filterNowInProgress).andForEach(radar.highlight);
    radar.enable();
  };
  
  var filterNowInProgress = function(i, listing) { return listing.inProgress; };
  
  var target = function(jobs) {
    var newListings = Listings(jobs);

    var notInNewList = function(i, listing) { return !newListings.names[listing.name]; };
    var notInOldList = function(i, listing) { return !currentListings.names[listing.name]; };
    var withChangedBuildNumbers = function(i, listing) { return currentListings.names[listing.name] && listing.buildNumber !== currentListings.names[listing.name].buildNumber; };
    var withChangedState = function(i, listing) { return currentListings.names[listing.name] && listing.state !== currentListings.names[listing.name].state; };
    
    filter(currentListings, notInNewList)           .andForEach(radar.remove);
    filter(newListings,     notInOldList)           .andForEach(radar.add);
    filter(newListings,     withChangedBuildNumbers).andForEach(radar.readd);
    filter(currentListings, filterNowInProgress)    .andForEach(radar.highlight);
    filter(newListings,     withChangedState)       .andForEach(radar.changeState);
    filter(newListings, function() { return true; }).andForEach(radar.updatePopupDetail);
    
    currentListings = newListings;
  };
  
  var filter = function(listings, filterFxn) { 
    return { andForEach: function(fxn) { 
      $(listings.values).filter(filterFxn).each(function() { fxn(this); });
    } };
  }
    
  return {
    target: target,
    initializeWith: initialize
  };
};

/** View of the Prey data (i.e. screen) */
var Radar = function(hudson, memory) {
  
  var currentlyExplodedView = false;
  
  var readd = function(listing) {
    removeAnd(listing, function() { add(listing); });
  };
  
  var remove = function(listing) {
    removeAnd(listing, function() {});
  };
   
  var removeAnd = function(listing, fxn) {
    $("#" + listing.name).hide("blind", { direction: "vertical" }, 3000);
    setTimeout(function() { $("#" + listing.name).dialog('destroy').remove(); 
                            $("#" + listing.name + "--detail").dialog('destroy').remove(); 
                            fxn(); }, 3000);
  }
  
  var describeAndMark = function(listing, description, username, newClass) {
    hudson.changeDescription(listing.name, listing.buildNumber, description + (username ? " by " + username : ""));
    removeAllClasses(listing, newClass);
  };
  
  var removeAllClasses = function(listing, newClass) {
    $("#" + listing.name).removeClass("broken failed unknown aborted passed flicker fixed").addClass(newClass);
    $("#" + listing.name + "--detail").removeClass("broken failed unknown aborted passed flicker fixed").addClass(newClass);  
    listing.state = newClass;
  }
  
  var explodeDetail = function(listing, closeAfter, andThen) {
    if (currentlyExplodedView) {
      setTimeout(function() { explodeDetail(listing, closeAfter, andThen); }, 500);
      return;
    }
    currentlyExplodedView = true;
    $("#jobs").hide('puff', {}, 1000);
    var username = memory.read('HudsonHawk.userName');
    var buttons = { 'View In Hudson': function() {  $(this).dialog("close"); window.open(listing.url); } };
    if (listing.state != 'fixed') {
      buttons['Status: Fixed'] = function() {  $(this).dialog("close"); describeAndMark(listing, 'Build: Fixed', username, 'fixed'); };
    } 
    if (listing.state != 'flicker') {
      buttons['Status: Flicker'] = function() {  $(this).dialog("close"); describeAndMark(listing, 'Build: Flicker', username, 'flicker'); };
    }
    
    $("#" + listing.name + '--detail').dialog({ 
      buttons: buttons,
      hide: "scale",
      width: 'auto',
      height: 'auto',
      modal: true,
      resizable: false,
      closeOnEscape: true,
      close: function() { andThen(); currentlyExplodedView = false; }
    });
    if (closeAfter > 0) {
      setTimeout(function() { $("#" + listing.name + '--detail').dialog('close'); }, closeAfter);
    }
  };
  
  var add = function(listing) {
    create(listing);
    explodeDetail(listing, 5000, function() {
      $("#jobs").show("blind", { direction: "vertical" }, 1100);
      setTimeout(function() { $("#" + listing.name).show("blind", { direction: "vertical" }, 2000); }, 1100);
    });
  };
  
  var load = function(listing) {
    create(listing);
    $("#" + listing.name).show();
  };
  
  var create = function(listing) {
    $('#jobs').prepend('<div id="' + listing.name + '" class="' + listing.state + ' job" style="display: none"><span>' + listing.name + ' <span class="count">(' + listing.numberSinceFailure + ')</span></span></div>');
    updatePopupDetail(listing);    
    $("#" + listing.name)
      .click(function() { explodeDetail(listing, 0, function() { $("#jobs").show("blind", { direction: "vertical" }, 2000); }); });
  };
  
  var updatePopupDetail = function(listing) {
    $("#" + listing.name + '--detail').remove();
    $('#details').prepend('<div id="' + listing.name + '--detail" class="' + listing.state + ' jobdetail" style="display: none">' + listing.name 
                          + '<div class="count">Failed for last ' + listing.numberSinceFailure + ' builds'
                          + (listing.progress ? ', and is ' + listing.progress + '% complete' : '') + '</div>'
                          + (listing.description ? '<div class="count">' + listing.description + '</div>' : '') +'</div>');
  };
  
  var highlight = function(listing) {
    progress_highlight(listing);
  };
  
  var progress_highlight = function(listing) {
    $("#" + listing.name + "--progress1").remove();
    $("#" + listing.name + "--progress2").remove();
    
    if (listing.progress >= 99) {
      $("#" + listing.name).addClass(listing.state);
      fade_highlight(listing);
    } else if (listing.progress < 1) {
      // nothing for now....
    } else {
      $("#" + listing.name)
         .append("<div id='" + listing.name + "--progress1' class='" + listing.state + "' style='z-index: -1; width: " + (listing.progress) + "%; height: 100%; position: absolute; left: 0; top: 0;'>&nbsp;</div>")
         .append("<div id='" + listing.name + "--progress2' class='" + listing.state + "' style='z-index: -1; width: " + (100 - listing.progress) + "%; height: 100%; position: absolute; right: 0; top: 0;'>&nbsp;</div>")
         .removeClass(listing.state);
      $("#" + listing.name + "--progress1").fadeTo(0, 0.5);
    }
  };
  
  var fade_highlight = function(listing) {
    var itemWhenInitiallyCalled = $("#" + listing.name).get(0);
    var elem = function() { return (itemWhenInitiallyCalled === $("#" + listing.name).get(0)) ? $(itemWhenInitiallyCalled) : $('objectThatDoesntExist'); }
    var fadeOut = function() {
      elem().fadeTo(2000, 0.3, function() {
        setTimeout(fadeIn, 2000);
      });
    };
    var fadeIn = function(item) {
      elem().fadeTo(2000, 1, function() {
        setTimeout(fadeOut, 1000);
      });
    };
    fadeOut();
  };
  
  var orig_highlight = function(listing) {
    $("#" + listing.name).effect("pulsate", { times: 10000 }, 5000);
  };
  
  // An alternate to consider if aesthetically more pleasing than newer highlighting options
  var alt_highlight = function(listing) {
    var itemWhenInitiallyCalled = $("#" + listing.name).get(0);
    var elem = function() { return (itemWhenInitiallyCalled === $("#" + listing.name).get(0)) ? $(itemWhenInitiallyCalled) : $('objectThatDoesntExist'); }
    var fadeOut = function() {
      elem().switchClass(listing.state, 'passed', 2500, 'linear', function() {
        setTimeout(fadeIn, 0);
      });
    };
    var fadeIn = function(item) {
      elem().switchClass('passed', listing.state, 2500, 'linear', function() {
        setTimeout(fadeOut, 0);
      });
    };
    fadeOut();
  }; 
  
  var changeState = function(listing) {
    removeAllClasses(listing, listing.state);
  };
  
  var enable = function() {
    $("#settings").click(function() { 
      territory.openSettingsAndThen(function(view) {
        location.reload(true);
      });
    });
    
    var params = window.location.href.slice(window.location.href.indexOf('?') + 1);
    if (params.indexOf('mini') > -1) {
      $('body').addClass('mini');
    }
    $('body').removeClass('notready').addClass('ready');
  };
  
  return { remove: remove, add: add, highlight: highlight, readd: readd, load: load, changeState: changeState, enable: enable, updatePopupDetail: updatePopupDetail };
};

/**  Storage utils (via Cookies or HTML5 storage if supported) */
var Memory = function() {
  var cookieStorage = {
    write: function(name, value) {
      var date = new Date();
      date.setTime(date.getTime() + (500 * 24 * 60 * 60 * 1000)); // 500 days from now
      document.cookie = name + "=" + value + "; expires=" + date.toGMTString() + "; path=/";
    },
    read: function(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') {
          c = c.substring(1, c.length);
        }
        if (c.indexOf(nameEQ) == 0) {
          return c.substring(nameEQ.length, c.length);
        }
      }
      return null;
    }
  }
  
  var hasLocalStorage = function() { return !$.browser.mozilla && !!localStorage; } ;// Firefox 3.5 has localStorage but it doesn't seem to work right....
  
  var storage = hasLocalStorage() ? { write: function(name, value) { localStorage.setItem(name, value); }, read: function(name) { return localStorage.getItem(name); } } : cookieStorage; 
  
  return {
    write: storage.write,
    erase: function(name) { storage.write(name, ""); },
    read: storage.read
  }
};

/** Configuration options */
var Territory = function(memory, hudson) {
  var serverUrl = function() { return memory.read('HudsonHawk.serverUrl') };
  var viewName = function() { return memory.read('HudsonHawk.viewName') };
  var userName = function() { return memory.read('HudsonHawk.userName') };
  var password = function() { return memory.read('HudsonHawk.password') };
  
  var popupRequestForInfo = function(title, formBuilder, okCallback) {
    var popup = $('#popup');
    popup.empty();
    popup.dialog({ 
      buttons: { 'OK': function() {  $(this).dialog("close"); okCallback(); } },
      hide: "slide",
      modal: true,
      width: 'auto',
      maxWidth: 400,
      height: 'auto',
      resizable: false,
      maxHeight: 800,
      closeOnEscape: true,
      title: title,
      open: function(event, ui) { formBuilder(popup); }
    });  
  };
  
  var openSettingsIfNotFilledIn = function(callbackOnOk) {
    if (serverUrl() && viewName() && userName()) {
      hudson.redirectTo(serverUrl(), userName(), password());
      callbackOnOk(viewName());
    } else {
      openSettings(callbackOnOk);
    }
  };
  
  var openSettings = function(callbackOnOk) {
    if (serverUrl()) {
      hudson.redirectTo(serverUrl(), userName(), password());
      refreshViewsOnPopup();
      refreshUsersOnPopup();
    }
    
    popupRequestForInfo("Settings", settingsForm, function() {
      var newUrl = $('#urlOption').val(); 
      memory.write('HudsonHawk.serverUrl', newUrl);        
      var newViewName = $('#viewOption').val(); 
      memory.write('HudsonHawk.viewName', newViewName);
      var newUsername = $('#userOption').val();
      memory.write('HudsonHawk.userName', newUsername);  
      var newPassword = $('#passwordOption').val();
      memory.write('HudsonHawk.password', newPassword);      
      hudson.redirectTo(newUrl, newUsername, newPassword);
      callbackOnOk(newViewName);
    });
  };
  
  var generateSelect = function(id, values) {
    var selectBox = ["<select id='" + id + "'>"];
    $.each(values, function(i, value) {
      selectBox[i + 1] = "<option value='" + value + "'>" + value + "</option>";
    });        
    selectBox.push("</select>");
    $('#' + id).replaceWith(selectBox.join(""));
  };
  
  var refreshViewsOnPopup = function() {
    $('#viewOption').replaceWith("<i id='viewOption'>Refreshing views from Hudson...</i>");
    hudson.viewsFor(function(views) {
      generateSelect("viewOption", $(views).map(function() { return this.name; }));
      $('#viewOption').val(memory.read('HudsonHawk.viewName'));
    });
  }; 
  
  var refreshUsersOnPopup = function() {
    $('#userOption').replaceWith("<i id='userOption'>Refreshing users from Hudson...</i>");
    hudson.usersFor(function(users) {
      generateSelect("userOption", $(users).map(function() { return this.user.fullName; }));
      $('#userOption').val(memory.read('HudsonHawk.userName'));
    });
  };
  
  var settingsForm = function(popup) {
    var table = "<table><tbody>" 
                + row("Hudson URL:", "<input id='urlOption' class='url' value='" + (serverUrl() || "http://") + "'></input>") 
                + row("View:", "<i id='viewOption'>" + (viewName() || "<none>") + "</i>")
                + row("User:", "<i id='userOption'>" + (userName() || "<none>") + "</i>")
                + row("Password:", "<input id='passwordOption' type='password' value='" + (password() || "") + "'></input>") 
                + "</tbody></table>";
    popup.append(table);
    $('#urlOption').change(function() { 
      hudson.redirectTo($('#urlOption').val(), userName(), password());
      refreshViewsOnPopup(); 
      refreshUsersOnPopup();
    });
  };
  
  var row = function(prompt, formElement) {
    return "<tr><td>" + prompt + "</td><td>" + formElement + "</td></tr>";
  };
  
  return { recallViewAndThen: openSettingsIfNotFilledIn, openSettingsAndThen: openSettings };
};

/** Hudson wrapper */
var Hudson = function() {  
  var hudsonUrl;
  var username;
  var password;
  
  var callHudsonFor = function(directory, depth, callback) {
    var requestUrl = hudsonUrl + directory;
    return $.ajax({
      url: requestUrl + 'api/json',
      dataType: 'jsonp',
      jsonp: 'jsonp',
      data: 'depth=' + depth,
      timeout: 10000,
      success: function(hudson) { hudson.__url = requestUrl; callback(hudson); },
      error: function(request, status, error) {
        alert("Error: " + requestUrl);
      }
    });    
  };
  
  var viewsFor = function(callback) {
    return callHudsonFor("", 0, function(hudson) { callback(hudson.views); });
  };

  var usersFor = function(callback) {
    return callHudsonFor("people/", 0, function(hudson) { callback(hudson.users); });
  };

  var failedJobsFor = function(view, callback) {
    var viewName = view ? "view/" + view + "/" : '';
    return callHudsonFor(viewName, 0, function(hudson) { 
      var failedJobs = $(hudson.jobs).filter(function() { return this.color.indexOf('blue') !== 0; });
      
      var count = failedJobs.length; 
      failedJobs.each(function(i, job) {
        callHudsonFor(viewName + "job/" + job.name + "/", 1, function(jobDetail) { 
          job.lastCompletedBuild = jobDetail.lastCompletedBuild; 
          job.lastStableBuild = jobDetail.lastStableBuild;
          if (jobDetail.lastBuild.building) {
            count++;
            callHudsonFor('computer/' + jobDetail.lastBuild.builtOn + '/', 1, function(slaveDetail) {
              updateJobProgress(job, slaveDetail, jobDetail);
              count--;
            });
          }
          count--; 
        }); 
      });
      
      var waitUntilJobDetailIsGathered = function() {
        if (count === 0) {
          failedJobs.sort(byTimestampAscending);
          callback(failedJobs);
        } else {
          setTimeout(waitUntilJobDetailIsGathered, 100);
        }
      };
      setTimeout(waitUntilJobDetailIsGathered, 100);
    });
  };
  
  var getProgressFromExecutable = function(job, jobDetail) {
    return function() {
      if (this.currentExecutable && this.currentExecutable.number === jobDetail.lastBuild.number) {
        job.progress = this.progress;
      }
    };
  };
  
  var updateJobProgress = function(job, slaveDetail, jobDetail) {
    job.inProgress = true;
    $.each(slaveDetail.executors, getProgressFromExecutable(job, jobDetail));
    $.each(slaveDetail.oneOffExecutors, getProgressFromExecutable(job, jobDetail));
    if (!job.progress || job.progress < 1) {
      var durationComplete = deriveProgressFrom(jobDetail);
      if (durationComplete > 0 && durationComplete < 1) {
        job.progress = durationComplete * 100;
      }
    }
  };
  
  var deriveProgressFrom = function(jobDetail) {
    var durationTotal = 0;
    $(jobDetail.builds).each(function() {
      durationTotal = durationTotal + this.duration
    });
    var averageDuration = durationTotal / jobDetail.builds.length;
    var currentDuration = new Date().getTime() - jobDetail.lastBuild.timestamp;
    return currentDuration / averageDuration;
  }
  
  var byTimestampAscending = function(a, b) { 
    var aStamp = a.lastCompletedBuild ? a.lastCompletedBuild : 0; 
    var bStamp = b.lastCompletedBuild ? b.lastCompletedBuild : 0; 
    return aStamp - bStamp; 
  }
  
  var redirectTo = function(dirtyUrl, newUsername, newPassword) {
    var cleanerUrl = dirtyUrl.indexOf('http') > -1 ? dirtyUrl : "http://" + dirtyUrl;
    hudsonUrl = cleanerUrl.charAt(cleanerUrl.length - 1) === '/' ? cleanerUrl : cleanerUrl + "/";
    username = newUsername;
    password = newPassword;
  };

  var descriptionQueue = [];
  var changeDescription = function(jobName, buildNumber, newDescription) {
    descriptionQueue.push({ job: jobName, num: buildNumber, desc: newDescription });
    
    if (!descriptionQueue.inProgress) {
      descriptionQueue.inProgress = true;
      login();
    } else if (changeDescription.loggingOut) {
      setTimeout(login, 1000);
    }
  };
  
  var continueTo = function(iframe, src, callback) {
    return function() {
      setTimeout(function() {
        iframe.unbind().attr('src', src).load(callback);
      }, 100);
    };
  };
  
  var login = function() {
    var iframeId = "authFrame" + new Date().getTime();
    var params = { j_username: username, j_password: password, remember_me: true, from: "/" };
    var loginSrc = hudsonUrl + "/j_acegi_security_check?Submit=log+in&" + $.param(params) + "&json=" + $.param($.toJSON(params));
    $('body').prepend('<iframe id="' + iframeId + '" style="display:none" src="' + loginSrc + '"></iframe>');
    var iframe = $('iframe#' + iframeId);
    iframe.load(continueTo(iframe, loginSrc, processDescriptionQueueWith(iframe)));
  };
  
  var processDescriptionQueueWith = function(iframe) {
    if (descriptionQueue.length == 0) {
      return logoutWith(iframe);
    } else {
      var change = descriptionQueue.shift();
      var changeSrc = hudsonUrl + '/job/' + change.job + '/' + change.num + '/submitDescription?Submit=Submit&description=' + encodeURI(change.desc) + '&json=' + $.param({ description: change.desc });
      return continueTo(iframe, changeSrc, function() { processDescriptionQueueWith(iframe); });
    }
  };
  
  var logoutWith = function(iframe) {
    changeDescription.loggingOut = true;
    var iframeId = iframe.id;
    var logoutSrc = hudsonUrl + '/logout';
    return continueTo(iframe, logoutSrc, function() {
      setTimeout(function() {
        $('iframe#' + iframeId).remove();
        descriptionQueue.inProgress = false;
        changeDescription.loggingOut = false;
      }, 100);
    });
  };
  
  return {
    viewsFor: viewsFor,
    failedJobsFor: failedJobsFor,
    usersFor: usersFor,
    redirectTo: redirectTo,
    changeDescription: changeDescription
  };
};

var memory = Memory();
var hudson = Hudson();
var radar = Radar(hudson, memory);
var prey = Prey(radar);
var territory = Territory(memory, hudson);
var hawk = Hawk(hudson, prey, territory);

hawk.awaken();

</script>
</body>
</html>
